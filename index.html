<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Authentication</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        #optenter {
            visibility: hidden;
        }
        #error, #errorotp {
            color: red;
        }
    </style>
</head>
<body>
    <h2>Phone Number Authentication</h2>
    
    <!-- Mobile number input -->
    <div id="mobileenter">
        <label for="mobilenum">Enter Mobile Number:</label>
        <input type="text" id="mobilenum" placeholder="Enter 10-digit mobile number">
        <div id="recaptcha-container"></div>
        <button onclick="login()">Send OTP</button>
        <p id="error"></p>
    </div>
    
    <!-- OTP input -->
    <div id="optenter">
        <label for="otpvalue">Enter OTP:</label>
        <input type="text" id="otpvalue" placeholder="Enter OTP">
        <button onclick="verify()">Verify OTP</button>
        <p id="errorotp"></p>
    </div>
    
    <script>
        let coderesult; // Moved coderesult declaration here

        window.onload = function() {
            render();
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBMIXxBISZnryQeOgKRs73TqVRXkshd0KM",
            authDomain: "krinkin-309ee.firebaseapp.com",
            projectId: "krinkin-309ee",
            storageBucket: "krinkin-309ee.appspot.com",
            messagingSenderId: "397386970252",
            appId: "1:397386970252:web:9655f412b4280a036d77a9"
        };

        firebase.initializeApp(firebaseConfig);

        function render() {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible', 
                'callback': function(response) {
                    login(); // Automatically call login if recaptcha is solved
                }
            });
            recaptchaVerifier.render();
        }

        function login() {
            var mobile = document.getElementById("mobilenum").value;
            var number = "+91" + mobile;
            if (mobile.length < 10) {
                window.alert("Enter correct mobile number");
            } else {
                firebase.auth().signInWithPhoneNumber(number, window.recaptchaVerifier).then(function (confirmResult) {
                    coderesult = confirmResult; // Properly assign the confirmResult to coderesult
                    document.getElementById("mobileenter").remove();
                    document.getElementById("optenter").style.visibility = "visible";
                }).catch(function (error) {
                    document.getElementById("error").innerHTML = error.message;
                });
            }
        }

        function verify() {
            var otp = document.getElementById("otpvalue").value;
            if (coderesult) {
                coderesult.confirm(otp).then(function (result) {
                    var user = result.user;
                    // window.location.replace("user.html");
                    console.log("Otp verified")
                }).catch(function (error) {
                    document.getElementById("errorotp").innerHTML = error.message;
                });
            } else {
                document.getElementById("errorotp").innerHTML = "OTP verification error. Please retry.";
            }
        }
    </script>
</body>
</html>
